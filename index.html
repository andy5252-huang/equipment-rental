<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é™„ä¸­æ©Ÿç ”ç¤¾å™¨æå€Ÿç”¨ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <header class="w-full max-w-4xl mb-6 text-center">
    <div class="flex items-center justify-center mb-2">
      <img src="https://www.hs.ntnu.edu.tw/static/webroot/G162268916978407/image/NP162270058363015.png" alt="åœ‹ç«‹è‡ºç£å¸«ç¯„å¤§å­¸é™„å±¬é«˜ç´šä¸­å­¸æ ¡å¾½" class="w-20 h-20 mr-2" />
      <h1 class="text-3xl font-bold text-indigo-600">é™„ä¸­æ©Ÿç ”ç¤¾å™¨æå€Ÿç”¨ç³»çµ±</h1>
    </div>
    <div id="currentTime" class="text-lg text-gray-600"></div>
  </header>

  <div class="w-full max-w-4xl grid md:grid-cols-2 gap-6">
    <div class="bg-white shadow-lg rounded-xl p-6">
      <h2 class="text-2xl font-bold text-indigo-600 mb-4">ğŸ“¦ å™¨æå€Ÿç”¨</h2>

      <label class="block text-sm mb-1">é¸æ“‡å™¨æ</label>
      <select id="item" class="w-full border border-gray-300 rounded p-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <!-- å‹•æ…‹å¡«å…… -->
      </select>

      <button id="manageItemsBtn" onclick="showLogin()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 mb-4">
        ğŸ› ï¸ ç®¡ç†å™¨ææ¸…å–®
      </button>

      <button id="logoutBtn" onclick="logout()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 mb-4 hidden">
        ğŸšª ç™»å‡º
      </button>

      <label class="block text-sm mb-1">æƒæ NFC å¡</label>
      <input type="text" id="nfcInput" class="w-full border border-gray-300 rounded p-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è«‹æƒæ NFC å¡..." />

      <button onclick="focusNFCInput()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 mb-2">
        ğŸ”„ é‡æ–°èšç„¦ NFC è¼¸å…¥
      </button>

      <button onclick="manualEntry()" class="w-full bg-gray-700 text-white py-2 rounded hover:bg-gray-800 mb-4">
        âœï¸ æ‰‹å‹•è¼¸å…¥
      </button>

      <div id="userInfo" class="text-center text-gray-700 font-medium mb-4"></div>

      <div id="loginForm" class="hidden">
        <h3 class="text-lg font-bold text-indigo-600 mb-2">ç®¡ç†å“¡ç™»éŒ„</h3>
        <label class="block text-sm mb-1">å¸³è™Ÿ</label>
        <input type="text" id="username" class="w-full border border-gray-300 rounded p-2 mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è¼¸å…¥å¸³è™Ÿ" />
        <label class="block text-sm mb-1">å¯†ç¢¼</label>
        <input type="password" id="password" class="w-full border border-gray-300 rounded p-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è¼¸å…¥å¯†ç¢¼" />
        <button onclick="login()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 mb-2">
          âœ… ç™»éŒ„
        </button>
        <button onclick="closeLogin()" class="w-full bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
          âŒ å–æ¶ˆ
        </button>
      </div>

      <div id="recordInput" class="hidden">
        <label class="block text-sm mb-1">ç­ç´š</label>
        <input type="text" id="newClass" class="w-full border border-gray-300 rounded p-2 mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />

        <label class="block text-sm mb-1">å§“å</label>
        <input type="text" id="newName" class="w-full border border-gray-300 rounded p-2 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" />

        <button onclick="submitManual()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
          âœ… é€å‡ºå€Ÿç”¨ç´€éŒ„
        </button>
      </div>

      <div id="itemManage" class="hidden">
        <h3 class="text-lg font-bold text-purple-600 mb-2">ç®¡ç†å™¨ææ¸…å–®</h3>
        <label class="block text-sm mb-1">æ–°å¢å™¨æ</label>
        <input type="text" id="newItem" class="w-full border border-gray-300 rounded p-2 mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è¼¸å…¥æ–°å™¨æåç¨±" />
        <button onclick="addItem()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 mb-2">
          â• æ–°å¢
        </button>
        <label class="block text-sm mb-1">ç¾æœ‰å™¨æ</label>
        <select id="existingItems" class="w-full border border-gray-300 rounded p-2 mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <!-- å‹•æ…‹å¡«å…… -->
        </select>
        <button onclick="deleteItem()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 mb-2">
          ğŸ—‘ï¸ åˆªé™¤é¸ä¸­å™¨æ
        </button>
        <button onclick="closeItemManage()" class="w-full bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
          âŒ é—œé–‰
        </button>
      </div>
    </div>

    <div class="bg-white shadow-lg rounded-xl p-6 overflow-auto">
      <h2 class="text-2xl font-bold text-green-600 mb-4">ğŸ“‹ å€Ÿç”¨ç´€éŒ„</h2>
      <table class="w-full text-sm text-left border">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">æ™‚é–“</th>
            <th class="border px-2 py-1">ç­ç´š</th>
            <th class="border px-2 py-1">å§“å</th>
            <th class="border px-2 py-1">å™¨æ</th>
          </tr>
        </thead>
        <tbody id="recordTable" class="text-gray-700">
          <tr><td colspan="4" class="text-center py-2">ğŸ”„ è®€å–ä¸­...</td></tr>
        </tbody>
      </table>
      <button onclick="loadRecords()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 mt-4">
        ğŸ”„ é‡æ–°è¼‰å…¥ç´€éŒ„
      </button>
    </div>
  </div>

  <p class="text-xs text-gray-400 mt-6 text-center">è«‹ä½¿ç”¨æ”¯æ´ HID NFC è®€å¡å™¨çš„è¨­å‚™</p>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxGKUAUmPc5xyDI0wbkfQvai8OEMSKy37TUcUb9UerSoVIy7k2QGxZbUE3uLyfh09Y9/exec";
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFcsha2D_jqY64xYXyeqbnQ3-PuZv7GobhL6VTFsFTvV_YeXaGNUHJLUhkwZB_zvVeO_t8zEZ-_JyR/pub?gid=946322504&single=true&output=csv";
    let currentCardId = "";
    let isAuthenticated = false;

    // é¡¯ç¤ºç•¶å‰æ™‚é–“
    function updateCurrentTime() {
      const now = new Date();
      const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      };
      document.getElementById("currentTime").textContent = now.toLocaleString('zh-TW', options);
    }

    // æ¯ç§’æ›´æ–°æ™‚é–“
    setInterval(updateCurrentTime, 1000);

    // è§£æç¹é«”ä¸­æ–‡æ™‚é–“æ ¼å¼ï¼š2025/6/15 ä¸‹åˆ 9:06:53
    function parseChineseDateTime(dateStr) {
      if (!dateStr) return null;
      dateStr = dateStr.replace("ä¸Šåˆ", "AM").replace("ä¸‹åˆ", "PM");
      const parts = dateStr.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})\s*(AM|PM)\s*(\d{1,2}):(\d{2}):(\d{2})/);
      if (!parts) {
        console.warn("ç„¡æ•ˆæ™‚é–“æ ¼å¼ï¼š", dateStr);
        return null;
      }
      let [, year, month, day, period, hour, minute, second] = parts;
      month = month.padStart(2, "0");
      day = day.padStart(2, "0");
      hour = parseInt(hour);
      if (period === "PM" && hour < 12) hour += 12;
      if (period === "AM" && hour === 12) hour = 0;
      hour = hour.toString().padStart(2, "0");
      const isoDate = `${year}-${month}-${day}T${hour}:${minute}:${second}`;
      const date = new Date(isoDate);
      return date;
    }

    window.onload = () => {
      loadRecords();
      setupNFCInput();
      loadItems();
      updateCurrentTime();
      updateManageButton();
    };

    // æ›´æ–°ç®¡ç†å™¨ææŒ‰éˆ•çš„é¡¯ç¤º
    function updateManageButton() {
      const manageBtn = document.getElementById("manageItemsBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      if (isAuthenticated) {
        manageBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
      } else {
        manageBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      }
    }

    // é¡¯ç¤ºç™»éŒ„è¡¨å–®
    function showLogin() {
      document.getElementById("loginForm").classList.remove("hidden");
      document.getElementById("recordInput").classList.add("hidden");
      document.getElementById("itemManage").classList.add("hidden");
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      document.getElementById("userInfo").innerText = "è«‹è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿå’Œå¯†ç¢¼";
    }

    // é—œé–‰ç™»éŒ„è¡¨å–®
    function closeLogin() {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("userInfo").innerText = "è«‹æƒæ NFC å¡æˆ–é¸æ“‡æ“ä½œ";
    }

    // ç™»éŒ„é©—è­‰
    function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (username === "admin" && password === "0000") {
        isAuthenticated = true;
        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("userInfo").innerText = "ç®¡ç†å“¡ç™»éŒ„æˆåŠŸ";
        updateManageButton();
        manageItems();
      } else {
        alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦");
        document.getElementById("userInfo").innerText = "âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
      }
    }

    // ç™»å‡º
    function logout() {
      isAuthenticated = false;
      document.getElementById("itemManage").classList.add("hidden");
      document.getElementById("userInfo").innerText = "å·²ç™»å‡ºï¼Œè«‹æƒæ NFC å¡æˆ–é¸æ“‡æ“ä½œ";
      updateManageButton();
    }

    // è¨­ç½® NFC è¼¸å…¥æ¡†ç›£è½
    function setupNFCInput() {
      const nfcInput = document.getElementById("nfcInput");
      nfcInput.focus();
      let debounceTimer;
      nfcInput.addEventListener("input", async (event) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          const cardId = event.target.value.trim();
          const cardIdPattern = /^\d{10}$/;
          if (cardId && cardIdPattern.test(cardId)) {
            nfcInput.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
            await processNFCInput(cardId);
          }
        }, 300); // 300ms é˜²æŠ–
      });
    }

    // é‡æ–°èšç„¦ NFC è¼¸å…¥æ¡†
    function focusNFCInput() {
      document.getElementById("nfcInput").focus();
      document.getElementById("userInfo").innerText = "è«‹æƒæ NFC å¡...";
    }

    // è¼‰å…¥å™¨ææ¸…å–®
    async function loadItems() {
      try {
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.set("action", "getItems");
        console.log("è¼‰å…¥å™¨ææ¸…å–®è«‹æ±‚ï¼š", url.toString());
        const res = await fetch(url.toString());
        if (!res.ok) {
          throw new Error(`ç„¡æ³•è¼‰å…¥å™¨ææ¸…å–®ï¼š${res.status} ${res.statusText}`);
        }
        // å…ˆè®€å–å›æ‡‰ç‚ºæ–‡å­—
        const text = await res.text();
        let items;
        try {
          // å˜—è©¦è§£æç‚º JSON
          const json = JSON.parse(text);
          if (json.status === "success" && Array.isArray(json.data)) {
            items = json.data;
          } else {
            throw new Error(`å¾Œç«¯å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼š${text}`);
          }
        } catch (jsonErr) {
          throw new Error(`å¾Œç«¯è¿”å›ç„¡æ•ˆ JSONï¼š${text}`);
        }
        const itemSelect = document.getElementById("item");
        const existingItemsSelect = document.getElementById("existingItems");
        itemSelect.innerHTML = '<option value="">è«‹é¸æ“‡å™¨æ</option>';
        existingItemsSelect.innerHTML = '<option value="">è«‹é¸æ“‡è¦åˆªé™¤çš„å™¨æ</option>';
        items.forEach(item => {
          const option1 = document.createElement("option");
          option1.value = item;
          option1.textContent = item;
          itemSelect.appendChild(option1);
          const option2 = document.createElement("option");
          option2.value = item;
          option2.textContent = item;
          existingItemsSelect.appendChild(option2);
        });
      } catch (err) {
        console.error("è¼‰å…¥å™¨ææ¸…å–®éŒ¯èª¤ï¼š", err);
        document.getElementById("userInfo").innerText = `âŒ ç„¡æ³•è¼‰å…¥å™¨ææ¸…å–®ï¼š${err.message}`;
      }
    }

    // é¡¯ç¤ºç®¡ç†å™¨æç•Œé¢
    function manageItems() {
      if (!isAuthenticated) {
        showLogin();
        return;
      }
      document.getElementById("itemManage").classList.remove("hidden");
      document.getElementById("recordInput").classList.add("hidden");
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("userInfo").innerText = "è«‹ç®¡ç†å™¨ææ¸…å–®";
    }

    // é—œé–‰ç®¡ç†å™¨æç•Œé¢
    function closeItemManage() {
      document.getElementById("itemManage").classList.add("hidden");
      document.getElementById("userInfo").innerText = "è«‹æƒæ NFC å¡æˆ–é¸æ“‡æ“ä½œ";
    }

    // æ–°å¢å™¨æ
    async function addItem() {
      if (!isAuthenticated) {
        alert("è«‹å…ˆç™»éŒ„ç®¡ç†å“¡å¸³è™Ÿ");
        showLogin();
        return;
      }
      const newItem = document.getElementById("newItem").value.trim();
      if (!newItem) {
        alert("è«‹è¼¸å…¥å™¨æåç¨±");
        return;
      }
      if (newItem.length > 50) {
        alert("å™¨æåç¨±éé•·ï¼Œè«‹ç¸®çŸ­è‡³ 50 å­—ä»¥å…§");
        return;
      }
      try {
        const data = new URLSearchParams({ action: "addItem", item: newItem });
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: data,
          headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
        if (!res.ok) {
          throw new Error(`æ–°å¢å™¨æå¤±æ•—ï¼š${res.status} ${res.statusText}`);
        }
        const json = await res.json();
        if (json.status === "success") {
          alert(`âœ… å·²æ–°å¢å™¨æï¼š${newItem}`);
          document.getElementById("newItem").value = "";
          await loadItems();
        } else {
          alert(`âŒ æ–°å¢å¤±æ•—ï¼š${json.message || "æœªçŸ¥éŒ¯èª¤"}`);
        }
      } catch (err) {
        alert(`âŒ æ–°å¢å™¨æå¤±æ•—ï¼š${err.message}`);
        console.error("æ–°å¢å™¨æéŒ¯èª¤ï¼š", err);
      }
    }

    // åˆªé™¤å™¨æ
    async function deleteItem() {
      if (!isAuthenticated) {
        alert("è«‹å…ˆç™»éŒ„ç®¡ç†å“¡å¸³è™Ÿ");
        showLogin();
        return;
      }
      const item = document.getElementById("existingItems").value;
      if (!item) {
        alert("è«‹é¸æ“‡è¦åˆªé™¤çš„å™¨æ");
        return;
      }
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤å™¨æã€Œ${item}ã€ï¼Ÿ`)) {
        return;
      }
      try {
        const data = new URLSearchParams({ action: "deleteItem", item: item });
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: data,
          headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
        if (!res.ok) {
          throw new Error(`åˆªé™¤å™¨æå¤±æ•—ï¼š${res.status} ${res.statusText}`);
        }
        const json = await res.json();
        if (json.status === "success") {
          alert(`âœ… å·²åˆªé™¤å™¨æï¼š${item}`);
          await loadItems();
        } else {
          alert(`âŒ åˆªé™¤å¤±æ•—ï¼š${json.message || "æœªçŸ¥éŒ¯èª¤"}`);
        }
      } catch (err) {
        alert(`âŒ åˆªé™¤å™¨æå¤±æ•—ï¼š${err.message}`);
        console.error("åˆªé™¤å™¨æéŒ¯èª¤ï¼š", err);
      }
    }

    // è™•ç† NFC è¼¸å…¥çš„å¡è™Ÿ
    async function processNFCInput(cardId) {
      const item = document.getElementById("item").value;
      if (!item) {
        alert("è«‹å…ˆé¸æ“‡å™¨æ");
        document.getElementById("userInfo").innerText = "â— è«‹å…ˆé¸æ“‡å™¨æ";
        return;
      }

      currentCardId = cardId;
      document.getElementById("userInfo").innerText = `æ­£åœ¨æŸ¥è©¢å¡è™Ÿ ${cardId}...`;
      try {
        const res = await fetch(`${GOOGLE_SCRIPT_URL}?cardId=${encodeURIComponent(cardId)}`);
        if (!res.ok) {
          throw new Error(`æŸ¥è©¢å¤±æ•—ï¼š${res.status} ${res.statusText}`);
        }
        const text = await res.text();
        console.log("æŸ¥è©¢çµæœï¼š", text);
        if (text && !text.startsWith("ç„¡æ•ˆå¡è™Ÿ") && !text.startsWith("ä¼ºæœå™¨éŒ¯èª¤")) {
          const [className, name] = text.split(",");
          if (!className || !name) {
            throw new Error("æŸ¥è©¢å›æ‡‰æ ¼å¼éŒ¯èª¤");
          }
          document.getElementById("userInfo").innerHTML = `ğŸ‘¤ ä½¿ç”¨è€…ï¼š<strong>${className} ${name}</strong>`;
          await submitRecord(cardId, className, name, item);
          document.getElementById("recordInput").classList.add("hidden");
        } else {
          document.getElementById("userInfo").innerText = `â— æ­¤å¡è™Ÿæœªç™»è¨˜ï¼Œè«‹å¡«å¯«ç­ç´šèˆ‡å§“å`;
          document.getElementById("recordInput").classList.remove("hidden");
          document.getElementById("newClass").value = "";
          document.getElementById("newName").value = "";
        }
      } catch (err) {
        alert(`æŸ¥è©¢å¤±æ•—ï¼š${err.message}`);
        document.getElementById("userInfo").innerText = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}`;
        console.error("æŸ¥è©¢éŒ¯èª¤ï¼š", err);
      }
    }

    // æ‰‹å‹•è¼¸å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶
    function manualEntry() {
      document.getElementById("recordInput").classList.remove("hidden");
      document.getElementById("itemManage").classList.add("hidden");
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("newClass").value = "";
      document.getElementById("newName").value = "";
      document.getElementById("userInfo").innerText = "è«‹è¼¸å…¥ç­ç´šèˆ‡å§“å";
      currentCardId = "";
    }

    // æ‰‹å‹•é€å‡ºå€Ÿç”¨ç´€éŒ„
    async function submitManual() {
      const className = document.getElementById("newClass").value.trim();
      const name = document.getElementById("newName").value.trim();
      const item = document.getElementById("item").value;
      if (!className || !name) {
        alert("è«‹å®Œæ•´è¼¸å…¥ç­ç´šèˆ‡å§“å");
        return;
      }
      if (!item) {
        alert("è«‹é¸æ“‡å™¨æ");
        return;
      }
      if (className.length > 20 || name.length > 20) {
        alert("ç­ç´šæˆ–å§“åéé•·ï¼Œè«‹ç¸®çŸ­è‡³ 20 å­—ä»¥å…§");
        return;
      }
      // ç”Ÿæˆç¬¦åˆå¾Œç«¯è¦æ±‚çš„ 10 ä½æ•¸å­— cardId
      const cardId = currentCardId || `000000${Math.floor(Math.random() * 10000)}`.slice(-10);
      document.getElementById("userInfo").innerHTML = `ğŸ‘¤ ä½¿ç”¨è€…ï¼š<strong>${className} ${name}</strong>`;
      document.getElementById("recordInput").classList.add("hidden");
      await submitRecord(cardId, className, name, item);
    }

    // é€å‡ºç´€éŒ„
    async function submitRecord(cardId, className, name, item) {
      if (!cardId || !className || !name || !item) {
        alert("ç¼ºå°‘å¿…è¦åƒæ•¸ï¼Œè«‹ç¢ºä¿å¡è™Ÿã€ç­ç´šã€å§“åå’Œå™¨æå·²å¡«å¯«");
        document.getElementById("userInfo").innerText = "âŒ ç¼ºå°‘å¿…è¦åƒæ•¸";
        return;
      }
      try {
        const data = new URLSearchParams({
          cardId,
          className,
          name,
          item
        });
        console.log("æäº¤ç´€éŒ„ï¼š", { cardId, className, name, item });
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: data,
          headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
        if (!res.ok) {
          throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ï¼š${res.status} ${res.statusText}`);
        }
        const json = await res.json();
        if (json.status === "success") {
          alert(`âœ… å·²è¨˜éŒ„ï¼š${className} ${name} å€Ÿç”¨ ${item}`);
          loadRecords();
        } else {
          alert(`âŒ é€å‡ºå¤±æ•—ï¼š${json.message || "æœªçŸ¥éŒ¯èª¤"}`);
        }
      } catch (err) {
        alert(`âŒ é€å‡ºå¤±æ•—ï¼š${err.message}ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¢ºèª Google Apps Script URL æ­£ç¢ºã€‚`);
        console.error("æäº¤éŒ¯èª¤ï¼š", err);
      }
    }

    // è®€å–æœ€æ–°å€Ÿç”¨ç´€éŒ„ä¸¦é¡¯ç¤º
    async function loadRecords() {
      const tbody = document.getElementById("recordTable");
      tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2">ğŸ”„ è®€å–ä¸­...</td></tr>`;
      try {
        const res = await fetch(sheetUrl);
        if (!res.ok) {
          throw new Error(`ç„¡æ³•è¼‰å…¥ CSVï¼š${res.status} ${res.statusText}`);
        }
        const csvText = await res.text();
        if (!csvText.trim()) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2">ç›®å‰ç„¡å€Ÿç”¨ç´€éŒ„</td></tr>`;
          return;
        }
        Papa.parse(csvText, {
          skipEmptyLines: true,
          complete: (result) => {
            const rows = result.data.slice(1).reverse();
            tbody.innerHTML = "";
            if (rows.length === 0 || (rows.length === 1 && rows[0].length < 5)) {
              tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2">ç›®å‰ç„¡å€Ÿç”¨ç´€éŒ„</td></tr>`;
              return;
            }
            for (const row of rows.slice(0, 10)) {
              if (row.length < 5) {
                console.warn("ç„¡æ•ˆè¡Œæ•¸æ“šï¼š", row);
                continue;
              }
              const [cardId, className, name, item, time] = row;
              if (!time || !className || !name || !item) {
                console.warn("ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š", row);
                continue;
              }
              const parsedDate = parseChineseDateTime(time);
              const displayTime = parsedDate ? parsedDate.toLocaleString("zh-TW") : "ç„¡æ•ˆæ™‚é–“";
              console.log("åŸå§‹æ™‚é–“ï¼š", time, "è§£æå¾Œï¼š", displayTime);
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td class="border px-2 py-1">${displayTime}</td>
                <td class="border px-2 py-1">${className}</td>
                <td class="border px-2 py-1">${name}</td>
                <td class="border px-2 py-1">${item}</td>
              `;
              tbody.appendChild(tr);
            }
            if (tbody.innerHTML === "") {
              tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2">ç›®å‰ç„¡å€Ÿç”¨ç´€éŒ„</td></tr>`;
            }
          },
          error: (err) => {
            console.error("PapaParse éŒ¯èª¤ï¼š", err);
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2 text-red-500">âŒ ç„¡æ³•è¼‰å…¥ç´€éŒ„ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨å…¬é–‹è¨­å®š</td></tr>`;
          }
        });
      } catch (err) {
        console.error("è¼‰å…¥ç´€éŒ„éŒ¯èª¤ï¼š", err);
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2 text-red-500">âŒ ç„¡æ³•è¼‰å…¥ç´€éŒ„ï¼š${err.message}</td></tr>`;
      }
    }
  </script>
</body>
</html>