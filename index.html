<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å™¨æå€Ÿç”¨ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-4xl grid md:grid-cols-2 gap-6">
    <!-- å€Ÿç”¨æ“ä½œå€ -->
    <div class="bg-white shadow-lg rounded-xl p-6">
      <h2 class="text-2xl font-bold text-indigo-600 mb-4">ğŸ“¦ å™¨æå€Ÿç”¨</h2>

      <label class="block text-sm mb-1">é¸æ“‡å™¨æ</label>
      <select id="item" class="w-full border border-gray-300 rounded p-2 mb-4">
        <option value="ç›¸æ©Ÿ">ğŸ“· ç›¸æ©Ÿ</option>
        <option value="è…³æ¶">ğŸ“ è…³æ¶</option>
        <option value="éº¥å…‹é¢¨">ğŸ¤ éº¥å…‹é¢¨</option>
      </select>

      <button onclick="scanNFC()" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 mb-2">
        ğŸ“² æƒæ NFC å¡
      </button>

      <button onclick="manualEntry()" class="w-full bg-gray-700 text-white py-2 rounded hover:bg-gray-800 mb-4">
        âœï¸ æ‰‹å‹•è¼¸å…¥
      </button>

      <div id="userInfo" class="text-center text-gray-700 font-medium mb-4"></div>

      <div id="recordInput" class="hidden">
        <label class="block text-sm mb-1">ç­ç´š</label>
        <input type="text" id="newClass" class="w-full border border-gray-300 rounded p-2 mb-2" />

        <label class="block text-sm mb-1">å§“å</label>
        <input type="text" id="newName" class="w-full border border-gray-300 rounded p-2 mb-4" />

        <button onclick="submitManual()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
          âœ… é€å‡ºå€Ÿç”¨ç´€éŒ„
        </button>
      </div>
    </div>

    <!-- ç´€éŒ„é¡¯ç¤ºå€ -->
    <div class="bg-white shadow-lg rounded-xl p-6 overflow-auto">
      <h2 class="text-2xl font-bold text-green-600 mb-4">ğŸ“‹ å€Ÿç”¨ç´€éŒ„</h2>
      <table class="w-full text-sm text-left border">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">æ™‚é–“</th>
            <th class="border px-2 py-1">ç­ç´š</th>
            <th class="border px-2 py-1">å§“å</th>
            <th class="border px-2 py-1">å™¨æ</th>
          </tr>
        </thead>
        <tbody id="recordTable" class="text-gray-700">
          <tr><td colspan="4" class="text-center py-2">ğŸ”„ è®€å–ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="text-xs text-gray-400 mt-6 text-center">è«‹ä½¿ç”¨æ”¯æ´ Web NFC çš„ Android è£ç½®èˆ‡ Chrome ç€è¦½å™¨</p>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyiH4l74Ctuy4SmcAPC1i4BJibq_TsQK6PxgAJIs3rjOgI9E-vKIXyeA6NECG67Pxsl/exec";
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFcsha2D_jqY64xYXyeqbnQ3-PuZv7GobhL6VTFsFTvV_YeXaGNUHJLUhkwZB_zvVeO_t8zEZ-_JyR/pub?gid=946322504&single=true&output=csv";
    let currentCardId = "";

    window.onload = () => {
      loadRecords();
    };

    // æ‰‹å‹•è¼¸å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶
    function manualEntry() {
      document.getElementById("recordInput").classList.remove("hidden");
      document.getElementById("newClass").value = "";
      document.getElementById("newName").value = "";
      document.getElementById("userInfo").innerText = "è«‹è¼¸å…¥ç­ç´šèˆ‡å§“å";
      currentCardId = ""; // æ¸…ç©ºå¡è™Ÿ
    }

    // æ‰‹å‹•é€å‡ºå€Ÿç”¨ç´€éŒ„
    async function submitManual() {
      const className = document.getElementById("newClass").value.trim();
      const name = document.getElementById("newName").value.trim();
      const item = document.getElementById("item").value;
      if (!className || !name) {
        alert("è«‹å®Œæ•´è¼¸å…¥ç­ç´šèˆ‡å§“å");
        return;
      }
      // æ‰‹å‹•è¼¸å…¥æ²’æœ‰å¡è™Ÿï¼Œç”¨ç‰¹æ®Šå­—ä¸²ä»£æ›¿
      const cardId = "manual_" + Date.now();
      document.getElementById("userInfo").innerHTML = `ğŸ‘¤ ä½¿ç”¨è€…ï¼š<strong>${className} ${name}</strong>`;
      document.getElementById("recordInput").classList.add("hidden");
      await submitRecord(cardId, className, name, item);
    }

    // NFC æƒæ
    async function scanNFC() {
      if (!("NDEFReader" in window)) {
        alert("æ­¤è£ç½®ä¸æ”¯æ´ Web NFCï¼Œè«‹ä½¿ç”¨ Android è£ç½® + Chrome");
        return;
      }

      const item = document.getElementById("item").value;
      if (!item) {
        alert("è«‹å…ˆé¸æ“‡å™¨æ");
        return;
      }

      const ndef = new NDEFReader();

      try {
        await ndef.scan();
        document.getElementById("userInfo").innerText = "è«‹å°‡ NFC å¡é è¿‘è£ç½®...";
        ndef.onreading = async (event) => {
          const decoder = new TextDecoder();
          for (const record of event.message.records) {
            currentCardId = decoder.decode(record.data);
            // æŸ¥è©¢ä½¿ç”¨è€…è³‡æ–™
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?cardId=${encodeURIComponent(currentCardId)}`);
            const text = await res.text();

            if (text) {
              const [className, name] = text.split(",");
              document.getElementById("userInfo").innerHTML = `ğŸ‘¤ ä½¿ç”¨è€…ï¼š<strong>${className} ${name}</strong>`;
              await submitRecord(currentCardId, className, name, item);
              document.getElementById("recordInput").classList.add("hidden");
            } else {
              document.getElementById("userInfo").innerText = `â— æ­¤å¡è™Ÿæœªç™»è¨˜ï¼Œè«‹å¡«å¯«ç­ç´šèˆ‡å§“å`;
              document.getElementById("recordInput").classList.remove("hidden");
              // æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œè®“ä½¿ç”¨è€…å¡«å¯«
              document.getElementById("newClass").value = "";
              document.getElementById("newName").value = "";
            }
            break;
          }
        };
      } catch (err) {
        alert("è®€å– NFC ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
      }
    }

    // é€å‡ºç´€éŒ„å‡½å¼ (POST åˆ° Apps Script)
    async function submitRecord(cardId, className, name, item) {
      const data = { cardId, className, name, item };
      try {
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });
        const result = await res.text();
        if (result === "æˆåŠŸ") {
          alert(`âœ… å·²è¨˜éŒ„ï¼š${className} ${name} å€Ÿç”¨ ${item}`);
          loadRecords();
        } else {
          alert("é€å‡ºå¤±æ•—ï¼š" + result);
        }
      } catch (err) {
        alert("é€å‡ºå¤±æ•—ï¼š" + err.message);
      }
    }

    // è®€å–æœ€æ–°å€Ÿç”¨ç´€éŒ„ä¸¦é¡¯ç¤º
    async function loadRecords() {
      try {
        const res = await fetch(sheetUrl);
        const csvText = await res.text();
        const rows = csvText.trim().split("\n").slice(1).reverse(); // æœ€æ–°çš„æ”¾ä¸Šé¢
        const tbody = document.getElementById("recordTable");
        tbody.innerHTML = "";
        if (rows.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2">ç›®å‰ç„¡å€Ÿç”¨ç´€éŒ„</td></tr>`;
          return;
        }
        for (const row of rows.slice(0, 10)) {
          // é€™è£¡æ‹†æ¬„ä½æ³¨æ„é€—è™Ÿå¯èƒ½åœ¨å­—ä¸²å…§ï¼Œé€™æ˜¯ç°¡æ˜“æ‹†æ³•ï¼Œå¦‚æœ‰ç‰¹æ®Šç¬¦è™Ÿè«‹æ”¹ç”¨ CSV è§£æå™¨
          const cols = row.split(",");
          // æ¬„ä½æ’åˆ—ï¼šå¡è™Ÿ,ç­ç´š,å§“å,å™¨æ,æ™‚é–“
          if (cols.length < 5) continue;
          const [cardId, className, name, item, time] = cols;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border px-2 py-1">${new Date(time).toLocaleString()}</td>
            <td class="border px-2 py-1">${className}</td>
            <td class="border px-2 py-1">${name}</td>
            <td class="border px-2 py-1">${item}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        document.getElementById("recordTable").innerHTML = `<tr><td colspan="4" class="text-center py-2 text-red-500">âŒ ç„¡æ³•è¼‰å…¥ç´€éŒ„</td></tr>`;
      }
    }
  </script>
</body>
</html>
